# CI/CD(持續整合與持續部屬)  
* 程式碼上傳至雲端後，雲端立即把程式碼運行在另一台機器上市上。  

## 實作 iris  
* 實作使用gitlab,請去gitlab官網申請帳號,並建立一個blank project(右上角的New project,底下已有一個建立的)
![image]() 
* 準備兩台虛擬機 
* 下載 sklearn、flask、pip
* 其中一台(T1)建立/進入測試資料夾  
mkdir test-iris  
cd test iris  
* gedit train_model.py  

import pickle  
from sklearn import datasets  
from sklearn.model_selection import train_test_split  
from sklearn import tree  

iris=datasets.load_iris()  
x=iris.data  
y=iris.target  

#labels for iris dataset   
labels ={  
  0: "setosa",  
  1: "versicolor",  
  2: "virginica"  
}  

x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=.25)  
classifier=tree.DecisionTreeClassifier()  
classifier.fit(x_train,y_train)  
predictions=classifier.predict(x_test)

#export the model
model_name = 'model.pkl'
print("finished training and dump the model as {0}".format(model_name))
pickle.dump(classifier, open(model_name,'wb'))

* gedit server.py

import pickle

from flask import Flask, request, jsonify

app = Flask(__name__)

model = pickle.load(open('model.pkl', 'rb'))
labels = {
  0: "versicolor",   
  1: "setosa",
  2: "virginica"
}

@app.route('/myapi', methods=['POST'])
def predict():
    # Get the data from the POST request.
    data = request.get_json(force = True)
    predict = model.predict(data['feature'])
    return jsonify(predict[0].tolist())

if __name__ == '__main__':
    app.run(debug = True, host = '0.0.0.0')
* gedit client.py
import requests
url = 'http://192.168.31.78:5000/api'
feature = [[5.8, 4.0, 1.2, 0.2]]     
labels ={
  0: "setosa",
  1: "versicolor",
  2: "virginica"
}

r = requests.post(url,json={'feature': feature})
print(labels[r.json()])

* gedit client.py
import requests

url = 'http://192.168.31.78:5000/api'
feature = [[5.8, 4.0, 1.2, 0.2]]      
labels ={
  0: "setosa",
  1: "versicolor",
  2: "virginica"
}

r = requests.post(url,json={'feature': feature})
print(labels[r.json()])

* 將test-iris打包成Dockerfile

FROM nitincypher/docker-ubuntu-python-pip

COPY ./requirements.txt /app/requirements.txt

WORKDIR /app

RUN pip install -r requirements.txt

COPY server.py /app

COPY train_model.py /app

CMD python /app/train_model.py && python /app/server.py

* gedit requirements.txt

sklearn
flask

* 建立鏡像檔

docker build -t iris:1.0 .
docker run -itd --name iris -p 5000:5000 iris:1.0

## gitlab將T1 T2建立連線
到.ssh資料夾
cat id_rsa.pub,如果沒有的話
* 產生金鑰
ssh-keygen
* 並貼在gitlab的SSH-keys上
![image]()

* 上傳至gitlab
git init
git config --global username "xxxxxxx(隨意)"
git config --global user.email "電子郵件"
git remote add orgin git@gitlab.com:xxxxxx/iris-0104
git add .
git commit -m "Initial commit"
git push -u origin master

* 建立gitlab-runner(T2)
curl -L --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64
chmod +x /usr/local/bin/gitlab-runner
useradd --comment 'GitLab Runner' --create-home gitlab-runner --shell /bin/bash
usermod -aG docker gitlab-runner

* 註冊gitlab-runner
gitlab-runner register
輸入下面的token
![image]()

* 在T1 gedit .gitlab-ci.yml 

stages:
  - deploy

docker-deploy:
  stage: deploy
  script:
    - docker build -t iris .
    - if [ $(docker ps -aq --filter name=iris) ]; then docker rm -f iris; fi
    - docker run -d -p 5000:5000 --name iris iris
  tags:
* 上傳
git add .gitlab-ci.yml
git commit -m "add"
git push -u origin master

